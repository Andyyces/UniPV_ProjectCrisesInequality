---
title: "Empirical Subchapter - Visualizations"
output: html_document
---

```{r}
# Load required packages
library(pacman)           
p_load(tidyverse, 
       janitor, 
       ggthemes, 
       scales,
       here)
```

```{r}
# Load RDS files
crisis_long <- readRDS(here("Data", "Clean", "crisis_long.rds"))
combined_data <- readRDS(here("Data", "Clean", "combined_data.rds"))
```

```{r}
# Rename variables for clarity based on WID and World Bank definitions
combined_data <- combined_data %>%
  rename(
    # === WEALTH VARIABLES (Average amounts) ===
    # Bottom 50%
    avg_wealth_bottom50_adults = ahweal992j_p0p50,      # Average household wealth, bottom 50% (adults)
    avg_wealth_bottom50_all = ahweal999j_p0p50,         # Average household wealth, bottom 50% (all ages)
    
    # Top 1%
    avg_wealth_top1_adults = ahweal992j_p99p100,        # Average household wealth, top 1% (adults)
    avg_wealth_top1_all = ahweal999j_p99p100,           # Average household wealth, top 1% (all ages)
    
    # === INCOME VARIABLES (Average amounts) ===
    # Bottom 50%
    avg_income_bottom50_adults = aptinc992j_p0p50,      # Average pre-tax income, bottom 50% (adults 20+)
    avg_income_bottom50_all = aptinc999j_p0p50,         # Average pre-tax income, bottom 50% (all ages)
    
    # Top 1%
    avg_income_top1_adults = aptinc992j_p99p100,        # Average pre-tax income, top 1% (adults 20+)
    avg_income_top1_all = aptinc999j_p99p100,           # Average pre-tax income, top 1% (all ages)
    
    # === WEALTH SHARES (%) ===
    wealth_share_bottom50_adults = shweal992j_p0p50,
    wealth_share_bottom50_all = shweal999j_p0p50,
    wealth_share_top1_adults = shweal992j_p99p100,
    wealth_share_top1_all = shweal999j_p99p100,
    
    # === INCOME SHARES (%) ===
    income_share_bottom50_adults = sptinc992j_p0p50,
    income_share_bottom50_all = sptinc999j_p0p50,
    income_share_top1_adults = sptinc992j_p99p100,
    income_share_top1_all = sptinc999j_p99p100,
    
    # === MACROECONOMIC INDICATORS ===
    gdp_growth = NY.GDP.MKTP.KD.ZG,                     # GDP growth (annual %)
    gdp_deflator = NY.GDP.DEFL.KD.ZG,                   # Inflation measure
    trade_pct_gdp = NE.TRD.GNFS.ZS,                     # Trade openness
    unemployment_rate = JI.UEM.1564.ZS,                 # Unemployment, ages 15-64
    govt_debt_pct_gdp = GC.DOD.TOTL.GD.ZS              # Central government debt
  )
```

```{r Graph 0}
# Create LATAM-wide GDP growth plot
plot0_data <- combined_data %>%
  # Aggregate across ALL countries
  group_by(year) %>%
  summarise(
    gdp_growth = mean(gdp_growth, na.rm = TRUE),
    banking_crises = max(banking_crises, na.rm = TRUE),
    currency_crises = max(currency_crises, na.rm = TRUE),
    debt_crises = max(debt_crises, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(gdp_growth)) %>%
  # Pivot crisis types to long format for faceting
  pivot_longer(
    cols = c(banking_crises, currency_crises, debt_crises),
    names_to = "crisis_type",
    values_to = "crisis"
  ) %>%
  mutate(
    crisis_type = recode(crisis_type,
                         banking_crises = "Banking Crises",
                         currency_crises = "Currency Crises",
                         debt_crises = "Debt Crises"),
    crisis_type = factor(crisis_type, levels = c("Banking Crises", "Currency Crises", "Debt Crises"))
  )

p0 <- ggplot(plot0_data, aes(x = year, y = gdp_growth)) +
  # Crisis shading per type
  geom_rect(
    data = plot0_data %>% filter(crisis == 1),
    inherit.aes = FALSE,
    aes(xmin = year - 0.5, xmax = year + 0.5, ymin = -Inf, ymax = Inf),
    fill = "grey60", alpha = 0.4
  ) +
  # Zero reference line
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey30", linewidth = 0.5) +
  # GDP growth line
  geom_line(color = "firebrick3", linewidth = 0.8, alpha = 0.9) +
  # Facet by crisis type
  facet_wrap(~ crisis_type, ncol = 1, scales = "fixed") +
  # Scales
  scale_x_continuous(breaks = seq(1970, 2020, 10)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  coord_cartesian(xlim = c(1970, 2025)) +
  # Theme
  theme_economist() +
  labs(
    title = "GDP Growth Rate in Latin America and Crises",
    subtitle = "Regional average annual GDP growth rate. Shaded areas: Crisis years by type",
    x = NULL,
    y = "GDP Growth Rate",
    caption = "Source: World Bank World Development Indicators & IMF Systemic Banking Crises Database"
  ) +
  theme(
    strip.text = element_text(face = "bold", size = 11, hjust = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0, margin = margin(b = 2)),  
    plot.subtitle = element_text(size = 10, color = "grey40", hjust = 0),
    plot.caption = element_text(size = 7, face = "bold", hjust = 0, margin = margin(t = 15)),
    axis.text = element_text(size = 8),
    axis.title.y = element_text(size = 9, margin = margin(r = 12))
  )


# Save
ggsave(
  filename = here("Output", "Figures", "Empirical Graph 0.png"),
  plot = p0,
  width = 7,
  height = 5.5,
  dpi = 300,
  bg = "white"
)

```



```{r Graph 1}
# 1. Build region variable
# 1. Build region variable and SET FACTOR LEVELS FIRST
combined_data <- combined_data %>%
  mutate(region_group = case_when(
    region == "Central America" ~ "Caribbean",
    country %in% c("Argentina", "Chile", "Paraguay", "Uruguay") ~ "South Cone",
    country %in% c("Colombia", "Peru", "Venezuela", "Ecuador", "Bolivia", 
                   "Guyana", "Suriname", "French Guiana") ~ "Andes & Amazons",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(region_group)) %>%
  # CRITICAL: Set factor BEFORE pivot
  mutate(region_group = forcats::fct_relevel(region_group, 
                                              "Caribbean", "Andes & Amazons", "South Cone"))

# 2. AGGREGATE BY SUBREGION - take mean across countries per year
regional_data <- combined_data %>%
  group_by(subregion, year) %>%
  summarise(
    income_share_top1_all = mean(income_share_top1_all, na.rm = TRUE),
    income_share_bottom50_all = mean(income_share_bottom50_all, na.rm = TRUE),
    all_crises = max(all_crises, na.rm = TRUE),  # Crisis if ANY country in subregion had one
    .groups = "drop"
  ) %>%
  # RE-APPLY factor levels after summarise
  mutate(subregion = factor(subregion, levels = c("Caribbean", "Andes & Amazons", "South Cone")))

# 3. Pivot for plotting
plot1_data <- regional_data %>%
  pivot_longer(
    cols = c(income_share_top1_all, income_share_bottom50_all),
    names_to = "group",
    values_to = "share"
  ) %>%
  mutate(group = recode(group,
                        income_share_top1_all = "Top 1%",
                        income_share_bottom50_all = "Bottom 50%"))

# 4. Create plot
p1 <- ggplot(plot1_data, aes(x = year, y = share, color = group)) +
  # Crisis shading
  geom_rect(
    data = plot1_data %>% 
      filter(all_crises == 1) %>% 
      distinct(year, subregion, all_crises),
    inherit.aes = FALSE,
    aes(xmin = year - 0.5, xmax = year + 0.5, ymin = -Inf, ymax = Inf),
    fill = "grey60", alpha = 0.4
  ) +
  # Smooth lines
  geom_line(linewidth = 0.8, alpha = 0.9) +
  # Faceting
  facet_wrap(~ subregion, ncol = 1, scales = "fixed") +
  # Colors
  scale_color_manual(
    values = c("Top 1%" = "firebrick3", "Bottom 50%" = "steelblue"),
    labels = c("Bottom 50%", "Top 1%")
  ) +
  # Scales - multiply by 100 to get percentages
  scale_x_continuous(breaks = seq(1960, 2020, 10)) +
  scale_y_continuous(
    labels = function(x) paste0(x * 100, "%"),  # MULTIPLY BY 100
    breaks = seq(0, 0.4, 0.1)
  ) +
  # Theme
  theme_economist() +
  labs(
    title = "Income Share Evolution Across Latin American Regions",
    subtitle = "Income share of Top 1% and Bottom 50% of population. Shaded areas: Crisis years",
    x = NULL,
    y = "Income Share",
    color = NULL,
    caption = "Source: World Inequality Database & IMF Systemic Banking Crises Database"
  ) +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    strip.text = element_text(face = "bold", size = 11, hjust = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0),
    plot.subtitle = element_text(size = 10, color = "grey40", hjust = 0),  # Left-aligned
    plot.caption = element_text(size = 7, face = "bold", hjust = 0, margin = margin(t = 15)),  # Bold, more space above
    axis.text = element_text(size = 8),
    axis.title.y = element_text(size = 9, margin = margin(r = 12))
  )

# 5. Save
ggsave(
  filename = here("Output", "Figures", "Empirical Graph 1.png"),
  plot = p1,
  width = 7,
  height = 5.5,
  dpi = 300,
  bg = "white"
)
```


```{r Graph 2}
# 1. AGGREGATE GDP GROWTH BY SUBREGION - take mean across countries per year
regional_growth_data <- combined_data %>%
  group_by(subregion, year) %>%
  summarise(
    gdp_growth = mean(gdp_growth, na.rm = TRUE),
    all_crises = max(all_crises, na.rm = TRUE),  # Crisis if ANY country in subregion had one
    .groups = "drop"
  ) %>%
  # RE-APPLY factor levels after summarise
  mutate(subregion = factor(subregion, levels = c("Caribbean", "Andes & Amazons", "South Cone")))

# 2. Create plot
# 3. Create plot
p2 <- ggplot(regional_growth_data, aes(x = year, y = gdp_growth)) +
  # Crisis shading
  geom_rect(
    data = regional_growth_data %>% 
      filter(all_crises == 1) %>% 
      distinct(year, subregion, all_crises) %>%
      mutate(subregion = factor(subregion, levels = c("Caribbean", "Andes & Amazons", "South Cone"))),
    inherit.aes = FALSE,
    aes(xmin = year - 0.5, xmax = year + 0.5, ymin = -Inf, ymax = Inf),
    fill = "grey60", alpha = 0.4
  ) +
  # Zero reference line
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey30", linewidth = 0.5) +
  # GDP growth line in firebrick
  geom_line(color = "firebrick3", linewidth = 0.8, alpha = 0.9) +
  # Faceting
  facet_wrap(~ subregion, ncol = 1, scales = "fixed") +
  # Scales
  scale_x_continuous(breaks = seq(1970, 2020, 10)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  coord_cartesian(xlim = c(1970, 2025)) +
  # Theme
  theme_economist() +
  labs(
    title = "GDP Growth Rate Across Latin American Regions",
    subtitle = "Average annual GDP growth rate by subregion. Shaded areas: Crisis years",
    x = NULL,
    y = "GDP Growth Rate",
    caption = "Source: World Bank World Development Indicators & IMF Systemic Banking Crises Database"
  ) +
  theme(
    strip.text = element_text(face = "bold", size = 11, hjust = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0, margin = margin(b = 8)),
    plot.subtitle = element_text(size = 10, color = "grey40", hjust = 0),
    plot.caption = element_text(size = 7, face = "bold", hjust = 0, margin = margin(t = 15)),
    axis.text = element_text(size = 8),
    axis.title.y = element_text(size = 9, margin = margin(r = 12))
  )


# 4. Save
ggsave(
  filename = here("Output", "Figures", "Empirical Graph 2.png"),
  plot = p2,
  width = 7,
  height = 5.5,
  dpi = 300,
  bg = "white"
)
```

```{r Plot 3}

# Aggregate debt data by subregion, from 1970 onward
regional_debt_data <- combined_data %>%
  filter(year >= 1990) %>%                 # keep 1970 onward
  group_by(subregion, year) %>%
  summarise(
    central_govt_debt = mean(govt_debt_pct_gdp, na.rm = TRUE),
    all_crises        = max(all_crises, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    subregion = factor(
      subregion,
      levels = c("Caribbean", "Andes & Amazons", "South Cone")
    )
  ) %>%
  filter(!is.na(central_govt_debt))


# Plot
p3 <- ggplot(regional_debt_data, aes(x = year, y = central_govt_debt)) +
  geom_rect(
    data = regional_debt_data %>%
      filter(all_crises == 1) %>%
      distinct(year, subregion, all_crises),
    inherit.aes = FALSE,
    aes(xmin = year - 0.5, xmax = year + 0.5, ymin = -Inf, ymax = Inf),
    fill = "grey60", alpha = 0.4
  ) +
  geom_line(color = "firebrick3", linewidth = 0.8, alpha = 0.9) +
  facet_wrap(~ subregion, ncol = 1, scales = "fixed") +
  scale_x_continuous(breaks = seq(1990, 2020, 10)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  coord_cartesian(xlim = c(1990, 2025)) +
  theme_economist() +
  labs(
    title = "Central Government Debt Across Latin American Regions",
    subtitle = "Average debt-to-GDP ratio by subregion. Shaded areas: Crisis years",
    x = NULL,
    y = "Central Govt Debt (% of GDP)",
    caption = "Source: World Bank World Development Indicators & IMF Systemic Banking Crises Database"
  ) +
  theme(
    strip.text = element_text(face = "bold", size = 11, hjust = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0, margin = margin(b = 2)),
     plot.subtitle = element_text(size = 10, color = "grey40", hjust = 0),
    plot.caption = element_text(size = 7, face = "bold", hjust = 0, margin = margin(t = 15)),
    axis.text = element_text(size = 8),
    axis.title.y = element_text(size = 9, margin = margin(r = 12))
  )

ggsave(
  filename = here("Output", "Figures", "Empirical Graph 3.png"),
  plot = p3,
  width = 7,
  height = 5.5,
  dpi = 300,
  bg = "white"
)

```




