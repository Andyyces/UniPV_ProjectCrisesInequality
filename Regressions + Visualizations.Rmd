---
title: "Regressions + Visualizations"
output: html_document
date: "2025-11-30"
---

```{r}
library(pacman)
p_load(dplyr,
       ggplot2,
       ggthemes,
       tidyr,
       patchwork,
       plm,
       stargazer,
       modelsummary)


combined_data <- readRDS("Data/Clean/combined_data.rds")
crisis_long <- readRDS("Data/Clean/crisis_long.rds")
```

## Regressions

```{r}
# Startign with 2WFE for each type of financial crisis separately
model_plm1x50 <- plm(sptinc992j_p0p50 ~ banking_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm2x50 <- plm(sptinc992j_p0p50 ~ currency_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm3x50 <- plm(sptinc992j_p0p50 ~ debt_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm4x50 <- plm(sptinc992j_p0p50 ~ twin_crises, data = combined_data, index = c("country", "year"), model = "within")

# Creating comparison table
models_crises <- stargazer(model_plm1x50, model_plm2x50, model_plm3x50, model_plm4x50,
                          type = "text",  # Use "html" for HTML or "latex" for LaTeX
                          title = "Comparison of Financial Crisis Types on Inequality",
                          column.labels = c("Banking", "Currency", "Debt", "Twin"),
                          covariate.labels = c("Crisis Indicator"),
                          dep.var.labels = "Pre-tax income share, bottom 50% (adults 20+)",
                          keep.stat = c("n", "rsq", "adj.rsq"))# ,
                          # out = "Output/Tables/crisis_comparison_bottom50.tex")
```

```{r}
model_plm1x1 <- plm(sptinc992j_p99p100 ~ banking_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm2x1 <- plm(sptinc992j_p99p100 ~ currency_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm3x1 <- plm(sptinc992j_p99p100 ~ debt_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm4x1 <- plm(sptinc992j_p99p100 ~ twin_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm5x1 <- plm(sptinc992j_p99p100 ~ triple_crises, data = combined_data, index = c("country", "year"), model = "within")
model_plm6x1 <- plm(sptinc992j_p99p100 ~ twin_and_triple_crises, data = combined_data, index = c("country", "year"), model = "within")

# Creating comparison table
models_crises <- stargazer(model_plm1x1, model_plm2x1, model_plm3x1, model_plm4x1,
                          type = "text",  # Use "html" for HTML or "latex" for LaTeX
                          title = "Comparison of Financial Crisis Types on Inequality",
                          column.labels = c("Banking", "Currency", "Debt", "Twin"),
                          covariate.labels = c("Crisis Indicator"),
                          dep.var.labels = "Pre-tax income share, top 1% (adults 20+)",
                          keep.stat = c("n", "rsq", "adj.rsq"))# ,
                          # out = "Output/Tables/crisis_comparison_top1.tex")
```

```{r}
# Startign with 2WFE for each type of financial crisis separately
model_growth1 <- plm(NY.GDP.MKTP.KD.ZG ~ banking_crises, data = combined_data, index = c("country", "year"), model = "within")
model_growth2 <- plm(NY.GDP.MKTP.KD.ZG ~ currency_crises, data = combined_data, index = c("country", "year"), model = "within")
model_growth3 <- plm(NY.GDP.MKTP.KD.ZG ~ debt_crises, data = combined_data, index = c("country", "year"), model = "within")
model_growth4 <- plm(NY.GDP.MKTP.KD.ZG ~ twin_crises, data = combined_data, index = c("country", "year"), model = "within")

# Creating comparison table
models_crises <- stargazer(model_growth1, model_growth2, model_growth3, model_growth4,
                          type = "text",  # Use "html" for HTML or "latex" for LaTeX
                          title = "Comparison of Financial Crisis Types on Growth",
                          column.labels = c("Banking", "Currency", "Debt", "Twin"),
                          covariate.labels = c("Crisis Indicator"),
                          dep.var.labels = "GDP growth (annual %)",
                          keep.stat = c("n", "rsq", "adj.rsq"))# ,
                          # out = "Output/Tables/crisis_comparison_growth.tex")




```


```{r REGRESION ON GROWTH FOR LATAM SUBREGIONS - ONLY GROWTH BC WAS THE ONLY SIGNIFICANT ONE}
combined_data <- combined_data %>%
  mutate(region_group = case_when(
    region == "Central America" ~ "Caribbean",
    country %in% c("Argentina", "Chile", "Paraguay", "Uruguay") ~ "South Cone",
    country %in% c("Colombia", "Peru", "Venezuela", "Ecuador", "Bolivia", 
                   "Guyana", "Suriname", "French Guiana") ~ "Andes & Amazons",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(region_group)) %>%
  # CRITICAL: Set factor BEFORE pivot
  mutate(region_group = forcats::fct_relevel(region_group, 
                                              "Caribbean", "Andes & Amazons", "South Cone"))

run_growth_models <- function(df) {
  list(
    plm(NY.GDP.MKTP.KD.ZG ~ banking_crises,  data = df,
        index = c("country", "year"), model = "within"),
    plm(NY.GDP.MKTP.KD.ZG ~ currency_crises, data = df,
        index = c("country", "year"), model = "within"),
    plm(NY.GDP.MKTP.KD.ZG ~ debt_crises,     data = df,
        index = c("country", "year"), model = "within"),
    plm(NY.GDP.MKTP.KD.ZG ~ twin_crises,     data = df,
        index = c("country", "year"), model = "within")
  )
}

# 2) Subset by subregion and run models
models_caribbean     <- run_growth_models(dplyr::filter(combined_data, region_group == "Caribbean"))
models_andes_amazons <- run_growth_models(dplyr::filter(combined_data, region_group == "Andes & Amazons"))
models_south_cone    <- run_growth_models(dplyr::filter(combined_data, region_group == "South Cone"))

# 3) Name them explicitly for stargazer
m_Car_bank  <- models_caribbean[[1]]
m_Car_curr  <- models_caribbean[[2]]
m_Car_debt  <- models_caribbean[[3]]
m_Car_twin  <- models_caribbean[[4]]

m_AA_bank   <- models_andes_amazons[[1]]
m_AA_curr   <- models_andes_amazons[[2]]
m_AA_debt   <- models_andes_amazons[[3]]
m_AA_twin   <- models_andes_amazons[[4]]

m_SC_bank   <- models_south_cone[[1]]
m_SC_curr   <- models_south_cone[[2]]
m_SC_debt   <- models_south_cone[[3]]
m_SC_twin   <- models_south_cone[[4]]


stargazer(
  # 12 models: 4 per subregion
  m_Car_bank, m_Car_curr, m_Car_debt, m_Car_twin,
  m_AA_bank,  m_AA_curr,  m_AA_debt,  m_AA_twin,
  m_SC_bank,  m_SC_curr,  m_SC_debt,  m_SC_twin,
  type = "text",        # "latex" or "html" for the paper
  title = "Effect of Different Crisis Types on GDP Growth by Subregion",
  dep.var.labels = "GDP growth (annual %)",
  covariate.labels = c("Crisis indicator"),
  keep.stat = c("n", "rsq", "adj.rsq"),
  # 12 column labels: 4 for each subregion
  column.labels = c(
    "Banking (Carib.)", "Currency (Carib.)", "Debt (Carib.)", "Twin (Carib.)",
    "Banking (Andes/Amaz.)", "Currency (Andes/Amaz.)", "Debt (Andes/Amaz.)", "Twin (Andes/Amaz.)",
    "Banking (South Cone)", "Currency (South Cone)", "Debt (South Cone)", "Twin (South Cone)"
  ),
  column.separate = rep(1, 12)   # avoid multi-row header complications
)

```


## Visualizations

```{r}
# We will use the crisis_long that we created in Data_Cleaning.Rmd file

# Create the plot with position dodge to show multiple crises in the same year
p <-ggplot(crisis_long, aes(x = Year, y = reorder(Country,
                                                  desc(Country)),
                            color = Crisis_Type)) +
  geom_point(size = 3, shape = 15, position = position_dodge(width = 0.6)) +
  scale_color_manual(
    values = c(
      "Banking Crises" = "#d62728",
      "Currency Crises" = "#1f77b4",
      "Debt Crises" = "#2ca02c"
    ),
    name = "Crisis Type"
  ) +
  labs(
    x = "Year",
    y = "Country"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.y = element_text(size = 9, face = "bold")
  )

# Save as PNG in A4 landscape orientation
ggsave("Output/Figures/financial_crises_plot.png", plot = p, 
       width = 297, height = 210, units = "mm", dpi = 300)

# Or portrait orientation if preferred
ggsave("Output/Figures/financial_crises_plot_portrait.png", plot = p, 
       width = 210, height = 297, units = "mm", dpi = 300)
p
```


```{r Same Plot but in Economist Theme}
library(ggthemes)
econ_colors <- economist_pal()(3)

p2 <- ggplot(crisis_long, aes(x = Year, y = reorder(Country, desc(Country)),
                        color = Crisis_Type)) +
  geom_point(size = 3, shape = 15, position = position_dodge(width = 0.6)) +
  scale_color_manual(
    values = c(
      "Banking Crises" = "firebrick",
      "Currency Crises" = econ_colors[1],
      "Debt Crises" = econ_colors[2]
    ),
    name = "Crisis Type"
  ) +
  labs(
    x = "Year",
    y = "Country"
  ) +
  theme_economist() +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(size = 9, face = "bold"),
    axis.title.y = element_text(margin = margin(r = 20))  
  )

ggsave("Output/Figures/crisis plot blue.png", plot = p2, 
       width = 210, height = 297, units = "mm", dpi = 300)

```

