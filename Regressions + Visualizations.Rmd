---
title: "Regressions + Visualizations"
output: html_document
date: "2025-11-30"
---

```{r}
library(pacman)
p_load(dplyr,
       ggplot2,
       ggthemes,
       tidyr,
       patchwork,
       plm,
       stargazer,
       modelsummary)


combined_data <- readRDS("Data/Clean/combined_data.rds")
crisis_long <- readRDS("Data/Clean/crisis_long.rds")
```

## Regressions

### No Controls

#### Dependent: Pre-tax income share, top 1%

```{r}
model_plm1x1 <- plm(sptinc992j_p99p100 ~ banking_crises + 
                      plm::lag(banking_crises, 1) + 
                      plm::lag(banking_crises, 2) +
                      plm::lag(banking_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm2x1 <- plm(sptinc992j_p99p100 ~ currency_crises +
                      plm::lag(currency_crises, 1) + 
                      plm::lag(currency_crises, 2) + 
                      plm::lag(currency_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm3x1 <- plm(sptinc992j_p99p100 ~ debt_crises + 
                      plm::lag(debt_crises, 1) + 
                      plm::lag(debt_crises, 2) +
                      plm::lag(debt_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm4x1 <- plm(sptinc992j_p99p100 ~ twin_crises + 
                      plm::lag(twin_crises, 1) + 
                      plm::lag(twin_crises, 2) + 
                      plm::lag(twin_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm5x1 <- plm(sptinc992j_p99p100 ~ triple_crises + 
                      plm::lag(triple_crises, 1) + 
                      plm::lag(triple_crises, 2) + 
                      plm::lag(triple_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm6x1 <- plm(sptinc992j_p99p100 ~ twin_and_triple_crises + 
                      plm::lag(twin_and_triple_crises, 1) + 
                      plm::lag(twin_and_triple_crises, 2) + 
                      plm::lag(twin_and_triple_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"),
                    model = "within")

# Creating coefficient mapping to align different crisis types
coef_map <- c(
  "banking_crises" = "Crisis (t)",
  "currency_crises" = "Crisis (t)",
  "debt_crises" = "Crisis (t)",
  "twin_crises" = "Crisis (t)",
  "plm::lag(banking_crises, 1)" = "Crisis (t-1)",
  "plm::lag(currency_crises, 1)" = "Crisis (t-1)",
  "plm::lag(debt_crises, 1)" = "Crisis (t-1)",
  "plm::lag(twin_crises, 1)" = "Crisis (t-1)",
  "plm::lag(banking_crises, 2)" = "Crisis (t-2)",
  "plm::lag(currency_crises, 2)" = "Crisis (t-2)",
  "plm::lag(debt_crises, 2)" = "Crisis (t-2)",
  "plm::lag(twin_crises, 2)" = "Crisis (t-2)",
  "plm::lag(banking_crises, 3)" = "Crisis (t-3)",
  "plm::lag(currency_crises, 3)" = "Crisis (t-3)",
  "plm::lag(debt_crises, 3)" = "Crisis (t-3)",
  "plm::lag(twin_crises, 3)" = "Crisis (t-3)"
)

# Creating the table
modelsummary(
  list("Banking" = model_plm1x1, 
       "Currency" = model_plm2x1, 
       "Debt" = model_plm3x1,
       "Twin" = model_plm4x1),
  coef_map = coef_map,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  title = "Effects of different Financial Crisis Types on Inequality",
  notes = "Dependent variable: Pre-tax income share, top 1% (adults 20+)",
  output = "Output/Tables/crisis_comparison_top1.tex"
)
```

#### Dependent: Pre-tax income share, bottom 50%

```{r}
model_plm1x50 <- plm(sptinc992j_p0p50 ~ banking_crises + 
                      plm::lag(banking_crises, 1) + 
                      plm::lag(banking_crises, 2) + 
                      plm::lag(banking_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm2x50 <- plm(sptinc992j_p0p50 ~ currency_crises +
                      plm::lag(currency_crises, 1) + 
                      plm::lag(currency_crises, 2) + 
                      plm::lag(currency_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm3x50 <- plm(sptinc992j_p0p50 ~ debt_crises + 
                      plm::lag(debt_crises, 1) + 
                      plm::lag(debt_crises, 2) + 
                      plm::lag(debt_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm4x50 <- plm(sptinc992j_p0p50 ~ twin_crises + 
                      plm::lag(twin_crises, 1) + 
                      plm::lag(twin_crises, 2) + 
                      plm::lag(twin_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm5x50 <- plm(sptinc992j_p0p50 ~ triple_crises + 
                      plm::lag(triple_crises, 1) + 
                      plm::lag(triple_crises, 2) + 
                      plm::lag(triple_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"), 
                    model = "within")

model_plm6x50 <- plm(sptinc992j_p0p50 ~ twin_and_triple_crises + 
                      plm::lag(twin_and_triple_crises, 1) + 
                      plm::lag(twin_and_triple_crises, 2) + 
                      plm::lag(twin_and_triple_crises, 3), 
                    data = combined_data, 
                    index = c("country", "year"),
                    model = "within")

# Creating comparison table
modelsummary(
  list("Banking" = model_plm1x50, 
       "Currency" = model_plm2x50, 
       "Debt" = model_plm3x50,
       "Twin" = model_plm4x50),

  coef_map = coef_map,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  title = "Effects of different Financial Crisis Types on Inequality",
  notes = "Dependent variable: Pre-tax income share, bottom 50% (adults 20+)",
  output = "Output/Tables/crisis_comparison_bottom50.tex"
)

# In case we need to see the output also in R
models_crises <- stargazer(model_plm1x50, model_plm2x50, model_plm3x50, model_plm4x50,
                          type = "text",  # Use "html" for HTML or "latex" for LaTeX
                          title = "Comparison of Financial Crisis Types on Inequality",
                          column.labels = c("Banking", "Currency", "Debt", "Twin"),
                          covariate.labels = c("Crisis Indicator"),
                          dep.var.labels = "Pre-tax income share, bottom 50% (adults 20+)",
                          keep.stat = c("n", "rsq", "adj.rsq"))
```

#### Dependent: Annual growth rate

```{r}
# Startign with 2WFE for each type of financial crisis separately
model_growth1 <- plm(NY.GDP.MKTP.KD.ZG ~ banking_crises +
                       plm::lag(banking_crises, 1) + 
                       plm::lag(banking_crises, 2) + 
                       plm::lag(banking_crises, 3), 
                     data = combined_data, 
                     index = c("country", "year"), 
                     model = "within")

model_growth2 <- plm(NY.GDP.MKTP.KD.ZG ~ currency_crises +
                       plm::lag(currency_crises, 1) + 
                       plm::lag(currency_crises, 2) + 
                       plm::lag(currency_crises, 3), 
                     data = combined_data, 
                     index = c("country", "year"), 
                     model = "within")

model_growth3 <- plm(NY.GDP.MKTP.KD.ZG ~ debt_crises +
                       plm::lag(debt_crises, 1) + 
                       plm::lag(debt_crises, 2) + 
                       plm::lag(debt_crises, 3), 
                     data = combined_data, 
                     index = c("country", "year"), 
                     model = "within")

model_growth4 <- plm(NY.GDP.MKTP.KD.ZG ~ twin_crises +
                       plm::lag(twin_crises, 1) + 
                       plm::lag(twin_crises, 2) + 
                       plm::lag(twin_crises, 3), 
                     data = combined_data, 
                     index = c("country", "year"), 
                     model = "within")

modelsummary(
  list("Banking" = model_growth1, 
       "Currency" = model_growth2, 
       "Debt" = model_growth3,
       "Twin" = model_growth4),
  coef_map = coef_map,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  title = "Comparison of Financial Crisis Types on Growth",
  notes = "Dependent variable: GDP growth (annual %)",
  output = "Output/Tables/crisis_comparison_growth.tex"
)
```

### With controls

Custom function so it's faster

```{r}
crisis_models_controls <- function(outcome, crisis_type, data, controls_string) {
  # Creating lag terms
  lags <- paste0("lag(", crisis_type, ", ", 1:3, ")", collapse = " + ")
  
  # Building full formula
  formula_str <- paste(outcome, "~", crisis_type, "+", lags, "+", controls_string)
  
  # Estimating model
  plm(as.formula(formula_str),
      data = data,
      index = c("country", "year"),
      model = "within")
}

my_controls <- "NY.GDP.DEFL.KD.ZG + NE.TRD.GNFS.ZS + JI.UEM.1564.ZS"
```

#### Dependent: GDP Growth

```{r}
model_growthcon1 <- crisis_models_controls("NY.GDP.MKTP.KD.ZG", "banking_crises", combined_data, my_controls)
model_growthcon2 <- crisis_models_controls("NY.GDP.MKTP.KD.ZG", "currency_crises", combined_data, my_controls)
model_growthcon3 <- crisis_models_controls("NY.GDP.MKTP.KD.ZG", "debt_crises", combined_data, my_controls)
model_growthcon4 <- crisis_models_controls("NY.GDP.MKTP.KD.ZG", "twin_crises", combined_data, my_controls)

summary(model_growthcon1)
summary(model_growthcon2)
summary(model_growthcon3)
summary(model_growthcon4)

# Coefficient mapping for controls table
coef_map_controls <- c(
  # Crisis variables at time t
  "banking_crises" = "Crisis (t)",
  "currency_crises" = "Crisis (t)",
  "debt_crises" = "Crisis (t)",
  "twin_crises" = "Crisis (t)",
  
  # Lagged crisis variables - note the format: lag(variable, n)
  "lag(banking_crises, 1)" = "Crisis (t-1)",
  "lag(currency_crises, 1)" = "Crisis (t-1)",
  "lag(debt_crises, 1)" = "Crisis (t-1)",
  "lag(twin_crises, 1)" = "Crisis (t-1)",
  
  "lag(banking_crises, 2)" = "Crisis (t-2)",
  "lag(currency_crises, 2)" = "Crisis (t-2)",
  "lag(debt_crises, 2)" = "Crisis (t-2)",
  "lag(twin_crises, 2)" = "Crisis (t-2)",
  
  "lag(banking_crises, 3)" = "Crisis (t-3)",
  "lag(currency_crises, 3)" = "Crisis (t-3)",
  "lag(debt_crises, 3)" = "Crisis (t-3)",
  "lag(twin_crises, 3)" = "Crisis (t-3)",
  
  # Control variables
  "NY.GDP.DEFL.KD.ZG" = "Inflation (GDP deflator)",
  "NE.TRD.GNFS.ZS" = "Trade openness",
  "JI.UEM.1564.ZS" = "Unemployment"
)

# Creating the table
modelsummary(
  list("Banking" = model_growthcon1,
       "Currency" = model_growthcon2,
       "Debt" = model_growthcon3,
       "Twin" = model_growthcon4),
  coef_map = coef_map_controls,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  title = "Effects of Financial Crises on GDP Growth (with Controls)",
  notes = "Dependent variable: GDP growth (annual %)",
  output = "Output/Tables/crisis_growth_controls.tex"
)
```

#### Dependent: Bottom 50%

```{r}
model_bot50con1 <- crisis_models_controls("sptinc992j_p0p50", "banking_crises", combined_data, my_controls)
model_bot50con2 <- crisis_models_controls("sptinc992j_p0p50", "currency_crises", combined_data, my_controls)
model_bot50con3 <- crisis_models_controls("sptinc992j_p0p50", "debt_crises", combined_data, my_controls)
model_bot50con4 <- crisis_models_controls("sptinc992j_p0p50", "twin_crises", combined_data, my_controls)

summary(model_bot50con1)
summary(model_bot50con2)
summary(model_bot50con3)
summary(model_bot50con4)

# Creating the table
modelsummary(
  list("Banking" = model_bot50con1,
       "Currency" = model_bot50con2,
       "Debt" = model_bot50con3,
       "Twin" = model_bot50con4),
  coef_map = coef_map_controls,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  title = "Effects of Financial Crises on Income Inequality (with Controls)",
  notes = "Pre-tax income share, bottom 50% (adults 20+)",
  output = "Output/Tables/crisis_bottom50_controls.tex"
)
```

#### Dependent: TOP 1%

```{r}
model_top1con1 <- crisis_models_controls("sptinc992j_p99p100", "banking_crises", combined_data, my_controls)
model_top1con2 <- crisis_models_controls("sptinc992j_p99p100", "currency_crises", combined_data, my_controls)
model_top1con3 <- crisis_models_controls("sptinc992j_p99p100", "debt_crises", combined_data, my_controls)
model_top1con4 <- crisis_models_controls("sptinc992j_p99p100", "twin_crises", combined_data, my_controls)

summary(model_top1con1)
summary(model_top1con2)
summary(model_top1con3)
summary(model_top1con4)

modelsummary(
  list("Banking" = model_top1con1,
       "Currency" = model_top1con2,
       "Debt" = model_top1con3,
       "Twin" = model_top1con4),
  coef_map = coef_map_controls,
  stars = c('*' = 0.1, '**' = 0.05, '***' = 0.01),
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  title = "Effects of Financial Crises on Income Inequality (with Controls)",
  notes = "Dependent variable: Pre-tax income share, top 1% (adults 20+)",
  output = "Output/Tables/crisis_top1_controls.tex"
)
```

### By subregions

```{r REGRESION ON GROWTH FOR LATAM SUBREGIONS - ONLY GROWTH BC WAS THE ONLY SIGNIFICANT ONE}
combined_data <- combined_data %>%
  mutate(region_group = case_when(
    region == "Central America" ~ "Caribbean",
    country %in% c("Argentina", "Chile", "Paraguay", "Uruguay") ~ "South Cone",
    country %in% c("Colombia", "Peru", "Venezuela", "Ecuador", "Bolivia", 
                   "Guyana", "Suriname", "French Guiana") ~ "Andes & Amazons",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(region_group)) %>%
  # CRITICAL: Set factor BEFORE pivot
  mutate(region_group = forcats::fct_relevel(region_group, 
                                              "Caribbean", "Andes & Amazons", "South Cone"))

run_lag_models <- function(df) {
  list(
    plm(NY.GDP.MKTP.KD.ZG ~ banking_crises +
          plm::lag(banking_crises, 1) +
          plm::lag(banking_crises, 2) +
          plm::lag(banking_crises, 3),
        data  = df,
        index = c("country", "year"),
        model = "within"),

    plm(NY.GDP.MKTP.KD.ZG ~ currency_crises +
          plm::lag(currency_crises, 1) +
          plm::lag(currency_crises, 2) +
          plm::lag(currency_crises, 3),
        data  = df,
        index = c("country", "year"),
        model = "within"),

    plm(NY.GDP.MKTP.KD.ZG ~ debt_crises +
          plm::lag(debt_crises, 1) +
          plm::lag(debt_crises, 2) +
          plm::lag(debt_crises, 3),
        data  = df,
        index = c("country", "year"),
        model = "within"),

    plm(NY.GDP.MKTP.KD.ZG ~ twin_crises +
          plm::lag(twin_crises, 1) +
          plm::lag(twin_crises, 2) +
          plm::lag(twin_crises, 3),
        data  = df,
        index = c("country", "year"),
        model = "within")
  )
}

# Caribbean
models_caribbean <- run_lag_models(
  filter(combined_data, region_group == "Caribbean")
)

# Andes & Amazons
models_andes_amazons <- run_lag_models(
  filter(combined_data, region_group == "Andes & Amazons")
)

# South Cone
models_south_cone <- run_lag_models(
  filter(combined_data, region_group == "South Cone")
)

# Caribbean
car_bank  <- models_caribbean[[1]]
car_curr  <- models_caribbean[[2]]
car_debt  <- models_caribbean[[3]]
car_twin  <- models_caribbean[[4]]

# Andes & Amazons
aa_bank   <- models_andes_amazons[[1]]
aa_curr   <- models_andes_amazons[[2]]
aa_debt   <- models_andes_amazons[[3]]
aa_twin   <- models_andes_amazons[[4]]

# South Cone
sc_bank   <- models_south_cone[[1]]
sc_curr   <- models_south_cone[[2]]
sc_debt   <- models_south_cone[[3]]
sc_twin   <- models_south_cone[[4]]

## 1) Caribbean
stargazer(
  car_bank, car_curr, car_debt, car_twin,
  type = "latex",
  title = "Effect of Crises on GDP Growth – Caribbean",
  dep.var.labels = "GDP growth (annual %)",
  column.labels = c("Banking", "Currency", "Debt", "Twin"),
  covariate.labels = c("Crisis(t)", "Crisis(t-1)", "Crisis(t-2)", "Crisis(t-3)"),
  keep.stat = c("n", "rsq", "adj.rsq"),
  omit.stat = c("f", "ser", "aic", "bic")
)

## 2) Andes & Amazons
stargazer(
  aa_bank, aa_curr, aa_debt, aa_twin,
  type = "latex",
  title = "Effect of Crises on GDP Growth – Andes & Amazons",
  dep.var.labels = "GDP growth (annual %)",
  column.labels = c("Banking", "Currency", "Debt", "Twin"),
  covariate.labels = c("Crisis(t)", "Crisis(t-1)", "Crisis(t-2)", "Crisis(t-3)"),
  keep.stat = c("n", "rsq", "adj.rsq"),
  omit.stat = c("f", "ser", "aic", "bic")
)

## 3) South Cone
stargazer(
  sc_bank, sc_curr, sc_debt, sc_twin,
  type = "latex",
  title = "Effect of Crises on GDP Growth – South Cone",
  dep.var.labels = "GDP growth (annual %)",
  column.labels = c("Banking", "Currency", "Debt", "Twin"),
  covariate.labels = c("Crisis(t)", "Crisis(t-1)", "Crisis(t-2)", "Crisis(t-3)"),
  keep.stat = c("n", "rsq", "adj.rsq"),
  omit.stat = c("f", "ser", "aic", "bic")
)



```

## Visualizations

```{r}
# We will use the crisis_long that we created in Data_Cleaning.Rmd file

# Create the plot with position dodge to show multiple crises in the same year
p <-ggplot(crisis_long, aes(x = Year, y = reorder(Country,
                                                  desc(Country)),
                            color = Crisis_Type)) +
  geom_point(size = 3, shape = 15, position = position_dodge(width = 0.6)) +
  scale_color_manual(
    values = c(
      "Banking Crises" = "#d62728",
      "Currency Crises" = "#1f77b4",
      "Debt Crises" = "#2ca02c"
    ),
    name = "Crisis Type"
  ) +
  labs(
    x = "Year",
    y = "Country"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.y = element_text(size = 9, face = "bold")
  )

# Save as PNG in A4 landscape orientation
ggsave("Output/Figures/financial_crises_plot.png", plot = p, 
       width = 297, height = 210, units = "mm", dpi = 300)

# Or portrait orientation if preferred
ggsave("Output/Figures/financial_crises_plot_portrait.png", plot = p, 
       width = 210, height = 297, units = "mm", dpi = 300)
p
```

```{r Same Plot but in Economist Theme}
library(ggthemes)
econ_colors <- economist_pal()(3)

p2 <- ggplot(crisis_long, aes(x = Year, y = reorder(Country, desc(Country)),
                        color = Crisis_Type)) +
  geom_point(size = 3, shape = 15, position = position_dodge(width = 0.6)) +
  scale_color_manual(
    values = c(
      "Banking Crises" = "firebrick",
      "Currency Crises" = econ_colors[1],
      "Debt Crises" = econ_colors[2]
    ),
    name = "Crisis Type"
  ) +
  labs(
    x = "Year",
    y = "Country"
  ) +
  theme_economist() +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(size = 9, face = "bold"),
    axis.title.y = element_text(margin = margin(r = 20))  
  )

ggsave("Output/Figures/crisis plot blue.png", plot = p2, 
       width = 210, height = 297, units = "mm", dpi = 300)

```
